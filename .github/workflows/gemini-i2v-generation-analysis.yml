name: Gemini Image-to-Video Generation & Analysis

on:
  workflow_dispatch:
    inputs:
      base_prompt:
        description: 'åŸºæœ¬ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆä¾‹ï¼šç¾ã—ã„æ¡œã®èŠ±ã³ã‚‰ã¨çŒ«ãŒéŠã¶é¢¨æ™¯ï¼‰'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.setup.outputs.branch_name }}
      folder_name: ${{ steps.setup.outputs.folder_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup branch and folder
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="video-generation-${TIMESTAMP}"
          FOLDER_NAME="video-${TIMESTAMP}"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b ${BRANCH_NAME}
          mkdir -p ${FOLDER_NAME}/planning ${FOLDER_NAME}/images ${FOLDER_NAME}/videos ${FOLDER_NAME}/analysis
          
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "folder_name=${FOLDER_NAME}" >> $GITHUB_OUTPUT
          
      - name: Commit initial structure
        run: |
          touch ${{ steps.setup.outputs.folder_name }}/README.md
          git add .
          git commit -m "ğŸ¬ Initialize video generation workflow"
          git push origin ${{ steps.setup.outputs.branch_name }}
          
      - name: Verify branch creation
        run: |
          echo "Created branch: ${{ steps.setup.outputs.branch_name }}"
          echo "Created folder: ${{ steps.setup.outputs.folder_name }}"
          git branch -v
          git remote -v
          
          # ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã®ç¢ºèª
          echo "Checking remote branches:"
          git ls-remote --heads origin | grep "${{ steps.setup.outputs.branch_name }}" || echo "Branch not found on remote"

  planning:
    needs: setup-branch
    runs-on: ubuntu-latest
    outputs:
      image_prompt: ${{ steps.plan.outputs.image_prompt }}
      video_prompt: ${{ steps.plan.outputs.video_prompt }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install google-generativeai
          
      - name: Plan generation strategy
        id: plan
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          mkdir -p ${{ needs.setup-branch.outputs.folder_name }}/planning
          
          python << 'EOF'
          import os
          import google.generativeai as genai
          
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          model = genai.GenerativeModel('gemini-1.5-flash')
          
          base_prompt = """${{ github.event.inputs.base_prompt }}"""
          
          planning_prompt = f"""åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {base_prompt}
          
          ä»¥ä¸‹ã®å†…å®¹ã§ç”»åƒç”Ÿæˆã¨å‹•ç”»ç”Ÿæˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
          
          1. ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆImagen4 Fastå‘ã‘ï¼‰:
          - é™çš„ãªç¾ã—ã•ã€æ§‹å›³ã€è‰²å½©ã€è³ªæ„Ÿã‚’é‡è¦–
          - é«˜å“è³ªãªç”»åƒç”Ÿæˆã«å¿…è¦ãªè©³ç´°ã‚’å«ã‚ã‚‹
          - 1è¡Œã§ç°¡æ½”ã«
          
          2. å‹•ç”»ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆHailuo-02 Proå‘ã‘ï¼‰:
          - å‹•ãã®è¦ç´ ã‚’å¼·èª¿
          - ã‚«ãƒ¡ãƒ©ãƒ¯ãƒ¼ã‚¯ã€ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã€æ™‚é–“çš„å¤‰åŒ–ã‚’å«ã‚ã‚‹
          - 1è¡Œã§ç°¡æ½”ã«
          
          3. è¨ˆç”»æˆ¦ç•¥:
          - ã©ã®ã‚ˆã†ãªè¦–è¦šçš„è¦ç´ ã‚’é‡è¦–ã™ã‚‹ã‹
          - æœŸå¾…ã•ã‚Œã‚‹çµæœ
          
          è¿”ç­”å½¢å¼:
          IMAGE_PROMPT: [ç”»åƒç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ]
          VIDEO_PROMPT: [å‹•ç”»ç”Ÿæˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ]
          STRATEGY: [è¨ˆç”»æˆ¦ç•¥]
          """
          
          response = model.generate_content(planning_prompt)
          result = response.text
          
          # ãƒ‘ãƒ¼ã‚¹çµæœ
          lines = result.split('\n')
          image_prompt = ""
          video_prompt = ""
          strategy = []
          
          for line in lines:
              if line.startswith('IMAGE_PROMPT:'):
                  image_prompt = line.replace('IMAGE_PROMPT:', '').strip()
              elif line.startswith('VIDEO_PROMPT:'):
                  video_prompt = line.replace('VIDEO_PROMPT:', '').strip()
              elif line.startswith('STRATEGY:'):
                  strategy.append(line.replace('STRATEGY:', '').strip())
              elif strategy and line.strip():
                  strategy.append(line.strip())
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
          folder = "${{ needs.setup-branch.outputs.folder_name }}/planning"
          
          with open(f"{folder}/image-prompt.md", "w", encoding="utf-8") as f:
              f.write(image_prompt)
          
          with open(f"{folder}/video-prompt.md", "w", encoding="utf-8") as f:
              f.write(video_prompt)
          
          with open(f"{folder}/planning-strategy.md", "w", encoding="utf-8") as f:
              f.write(f"# ç”Ÿæˆè¨ˆç”»æˆ¦ç•¥\n\n")
              f.write(f"## åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ\n{base_prompt}\n\n")
              f.write(f"## æˆ¦ç•¥\n")
              f.write('\n'.join(strategy))
          
          # GitHub Outputã«è¨­å®š
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"image_prompt={image_prompt}\n")
              f.write(f"video_prompt={video_prompt}\n")
          EOF
          
      - name: Commit planning results
        run: |
          git add .
          git commit -m "ğŸ“ Add generation planning"
          git push

  generate-image:
    needs: [setup-branch, planning]
    runs-on: ubuntu-latest
    outputs:
      image_url: ${{ steps.generate.outputs.image_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests pillow
          
      - name: Generate image
        id: generate
        run: |
          mkdir -p ${{ needs.setup-branch.outputs.folder_name }}/images
          
          python << 'EOF'
          import requests
          import json
          import os
          import time
          
          # MCP Server URL
          mcp_url = "https://mcp-creatify-lipsync-20250719-010824-a071b7b8-820994673238.us-central1.run.app/t2i/fal/imagen4/fast"
          
          prompt = """${{ needs.planning.outputs.image_prompt }}"""
          
          # APIå‘¼ã³å‡ºã—
          payload = {
              "prompt": prompt,
              "image_size": "landscape_16_9",
              "num_inference_steps": 50,
              "seed": int(time.time())
          }
          
          try:
              response = requests.post(
                  f"{mcp_url}/api/tool/call",
                  json={
                      "name": "generate_image",
                      "arguments": payload
                  },
                  headers={"Content-Type": "application/json"},
                  timeout=300
              )
              
              if response.status_code == 200:
                  result = response.json()
                  if "content" in result and len(result["content"]) > 0:
                      content = result["content"][0]
                      if "url" in content:
                          image_url = content["url"]
                      else:
                          image_url = content.get("text", "")
                          # URLã‚’æŠ½å‡º
                          if "http" in image_url:
                              import re
                              urls = re.findall(r'https?://[^\s]+', image_url)
                              if urls:
                                  image_url = urls[0]
                  else:
                      raise Exception("No content in response")
              else:
                  raise Exception(f"API error: {response.status_code}")
              
              # ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              img_response = requests.get(image_url, stream=True)
              if img_response.status_code == 200:
                  with open("${{ needs.setup-branch.outputs.folder_name }}/images/generated-image.jpg", "wb") as f:
                      for chunk in img_response.iter_content(chunk_size=8192):
                          f.write(chunk)
              
              # URLã‚’ä¿å­˜
              with open("${{ needs.setup-branch.outputs.folder_name }}/images/image-url.txt", "w") as f:
                  f.write(image_url)
              
              # GitHub Outputã«è¨­å®š
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"image_url={image_url}\n")
                  
          except Exception as e:
              print(f"Error: {e}")
              # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒã‚’ä½œæˆ
              from PIL import Image, ImageDraw, ImageFont
              img = Image.new('RGB', (1920, 1080), color='lightblue')
              draw = ImageDraw.Draw(img)
              draw.text((50, 50), f"Prompt: {prompt[:100]}...", fill='black')
              img.save("${{ needs.setup-branch.outputs.folder_name }}/images/generated-image.jpg")
              
              placeholder_url = "https://via.placeholder.com/1920x1080"
              with open("${{ needs.setup-branch.outputs.folder_name }}/images/image-url.txt", "w") as f:
                  f.write(placeholder_url)
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"image_url={placeholder_url}\n")
          EOF
          
      - name: Commit image
        run: |
          git add .
          git commit -m "ğŸ–¼ï¸ Add generated image"
          git push

  generate-video:
    needs: [setup-branch, planning, generate-image]
    runs-on: ubuntu-latest
    outputs:
      video_url: ${{ steps.generate.outputs.video_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests pillow
          
      - name: Generate video
        id: generate
        run: |
          mkdir -p ${{ needs.setup-branch.outputs.folder_name }}/videos
          
          python << 'EOF'
          import requests
          import json
          import os
          import time
          
          # MCP Server URL
          mcp_url = "https://mcp-creatify-lipsync-20250719-010824-a071b7b8-820994673238.us-central1.run.app/i2v/fal/minimax/hailuo-02/pro"
          
          image_url = """${{ needs.generate-image.outputs.image_url }}"""
          prompt = """${{ needs.planning.outputs.video_prompt }}"""
          
          # APIå‘¼ã³å‡ºã—
          payload = {
              "image_url": image_url,
              "prompt": prompt,
              "duration": "5",
              "seed": int(time.time())
          }
          
          try:
              response = requests.post(
                  f"{mcp_url}/api/tool/call",
                  json={
                      "name": "generate_video",
                      "arguments": payload
                  },
                  headers={"Content-Type": "application/json"},
                  timeout=600
              )
              
              if response.status_code == 200:
                  result = response.json()
                  if "content" in result and len(result["content"]) > 0:
                      content = result["content"][0]
                      if "url" in content:
                          video_url = content["url"]
                      else:
                          video_url = content.get("text", "")
                          # URLã‚’æŠ½å‡º
                          if "http" in video_url:
                              import re
                              urls = re.findall(r'https?://[^\s]+\.mp4', video_url)
                              if urls:
                                  video_url = urls[0]
                  else:
                      raise Exception("No content in response")
              else:
                  raise Exception(f"API error: {response.status_code}")
              
              # å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              vid_response = requests.get(video_url, stream=True)
              if vid_response.status_code == 200:
                  with open("${{ needs.setup-branch.outputs.folder_name }}/videos/generated-video.mp4", "wb") as f:
                      for chunk in vid_response.iter_content(chunk_size=8192):
                          f.write(chunk)
              
              # URLã‚’ä¿å­˜
              with open("${{ needs.setup-branch.outputs.folder_name }}/videos/video-url.txt", "w") as f:
                  f.write(video_url)
              
              # GitHub Outputã«è¨­å®š
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"video_url={video_url}\n")
                  
          except Exception as e:
              print(f"Error: {e}")
              # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
              placeholder_url = "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
              with open("${{ needs.setup-branch.outputs.folder_name }}/videos/video-url.txt", "w") as f:
                  f.write(placeholder_url)
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"video_url={placeholder_url}\n")
          EOF
          
      - name: Commit video
        run: |
          git add .
          git commit -m "ğŸ¥ Add generated video"
          git push

  analyze-video:
    needs: [setup-branch, generate-video, planning]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install google-generativeai
          
      - name: Analyze video
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          mkdir -p ${{ needs.setup-branch.outputs.folder_name }}/analysis
          
          python << 'EOF'
          import os
          import google.generativeai as genai
          
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          model = genai.GenerativeModel('gemini-1.5-flash')
          
          video_url = """${{ needs.generate-video.outputs.video_url }}"""
          original_prompt = """${{ github.event.inputs.base_prompt }}"""
          video_prompt = """${{ needs.planning.outputs.video_prompt }}"""
          
          analysis_prompt = f"""å‹•ç”»URLã‚’åˆ†æã—ã¦ãã ã•ã„: {video_url}
          
          å…ƒã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {original_prompt}
          å‹•ç”»ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {video_prompt}
          
          ä»¥ä¸‹ã®è¦³ç‚¹ã§è©³ç´°ãªåˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
          
          ## 1. æŠ€è¡“çš„å“è³ª
          - è§£åƒåº¦ã¨ã‚¯ãƒªã‚¢ã•
          - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ
          - ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®æœ‰ç„¡
          
          ## 2. èŠ¸è¡“çš„å“è³ª
          - æ§‹å›³ã¨ã‚«ãƒ¡ãƒ©ãƒ¯ãƒ¼ã‚¯
          - è‰²å½©ã¨ç…§æ˜
          - å…¨ä½“çš„ãªç¾çš„ä¾¡å€¤
          
          ## 3. ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã¨å‹•ã
          - å‹•ãã®è‡ªç„¶ã•
          - ç‰©ç†æ³•å‰‡ã®éµå®ˆ
          - ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã®æ»‘ã‚‰ã‹ã•
          
          ## 4. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã®ä¸€è‡´åº¦
          - è¦æ±‚ã•ã‚ŒãŸè¦ç´ ã®å­˜åœ¨
          - å‰µé€ çš„è§£é‡ˆã®é©åˆ‡ã•
          - æœŸå¾…ã¨ã®ä¹–é›¢
          
          ## 5. æ”¹å–„ææ¡ˆ
          - ã‚ˆã‚Šè‰¯ã„çµæœã®ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„æ¡ˆ
          - æŠ€è¡“çš„ãªæ¨å¥¨äº‹é …
          - æ¬¡å›ç”Ÿæˆæ™‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
          
          ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
          """
          
          response = model.generate_content(analysis_prompt)
          analysis = response.text
          
          # åˆ†æçµæœã‚’ä¿å­˜
          with open("${{ needs.setup-branch.outputs.folder_name }}/analysis/video-analysis.md", "w", encoding="utf-8") as f:
              f.write(f"# å‹•ç”»åˆ†æãƒ¬ãƒãƒ¼ãƒˆ\n\n")
              f.write(f"**å‹•ç”»URL**: {video_url}\n\n")
              f.write(f"**ç”Ÿæˆæ—¥æ™‚**: $(date)\n\n")
              f.write(f"---\n\n")
              f.write(analysis)
          EOF
          
      - name: Commit analysis
        run: |
          git add .
          git commit -m "ğŸ“Š Add video analysis"
          git push

  create-summary:
    needs: [setup-branch, planning, generate-image, generate-video, analyze-video]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Create summary README
        run: |
          cat > ${{ needs.setup-branch.outputs.folder_name }}/README.md << 'EOF'
          # ç”»åƒâ†’å‹•ç”»ç”Ÿæˆçµæœ
          
          ## æ¦‚è¦
          - **åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: ${{ github.event.inputs.base_prompt }}
          - **ç”Ÿæˆæ—¥æ™‚**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
          - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID**: ${{ github.run_id }}
          
          ## ç”Ÿæˆçµæœ
          
          ### ç”»åƒ
          ![Generated Image](images/generated-image.jpg)
          - [ç”»åƒURL](images/image-url.txt)
          
          ### å‹•ç”»
          - [ç”Ÿæˆã•ã‚ŒãŸå‹•ç”»ã‚’è¦‹ã‚‹](videos/generated-video.mp4)
          - [å‹•ç”»URL](videos/video-url.txt)
          
          ## è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          
          - ğŸ“‹ [è¨ˆç”»æˆ¦ç•¥](planning/planning-strategy.md)
          - ğŸ¨ [ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ](planning/image-prompt.md)
          - ğŸ¬ [å‹•ç”»ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ](planning/video-prompt.md)
          - ğŸ“Š [å‹•ç”»åˆ†æãƒ¬ãƒãƒ¼ãƒˆ](analysis/video-analysis.md)
          
          ## ä½¿ç”¨æŠ€è¡“
          
          - **ç”»åƒç”Ÿæˆ**: Imagen4 Fast (via MCP Server)
          - **å‹•ç”»ç”Ÿæˆ**: Hailuo-02 Pro (via MCP Server)
          - **åˆ†æ**: Gemini 1.5 Flash
          
          ---
          
          *ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯AIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          EOF
          
      - name: Commit summary
        run: |
          git add .
          git commit -m "ğŸ“š Add workflow summary"
          git push

  create-pull-request:
    needs: [setup-branch, create-summary]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Debug branch information
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "Target branch: ${{ needs.setup-branch.outputs.branch_name }}"
          echo "Folder: ${{ needs.setup-branch.outputs.folder_name }}"
          git log --oneline -n 5
          ls -la ${{ needs.setup-branch.outputs.folder_name }}/ || echo "Folder not found"
          
      - name: Verify GitHub token and permissions
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "Checking GitHub token..."
          if [ -z "$GH_TOKEN" ]; then
            echo "Error: No GitHub token found"
            exit 1
          fi
          echo "GitHub token is set (length: ${#GH_TOKEN})"
          
          # ãƒˆãƒ¼ã‚¯ãƒ³ã®ç¨®é¡ã‚’ç¢ºèª
          if [ -n "$PAT_TOKEN" ]; then
            echo "Using PAT_TOKEN for authentication"
          else
            echo "Using GITHUB_TOKEN for authentication"
            echo "Note: GITHUB_TOKEN may have limited PR creation permissions"
          fi
          
          # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¢ºèª
          gh repo view ${{ github.repository }} --json name,owner || echo "Repository access check failed"
          
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # PRãƒœãƒ‡ã‚£ã‚’ä½œæˆ
          cat > pr_body.md << 'EOF'
          ## ç”»åƒâ†’å‹•ç”»ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†
          
          ### ç”Ÿæˆå†…å®¹
          **åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: ${{ github.event.inputs.base_prompt }}
          
          ### æˆæœç‰©
          - ğŸ“ **ãƒ•ã‚©ãƒ«ãƒ€**: `${{ needs.setup-branch.outputs.folder_name }}/`
          - ğŸ–¼ï¸ **ç”»åƒ**: ç”Ÿæˆå®Œäº†
          - ğŸ¥ **å‹•ç”»**: ç”Ÿæˆå®Œäº†
          - ğŸ“Š **åˆ†æ**: å®Œäº†
          
          ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          1. ç”Ÿæˆçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„
          2. å¿…è¦ã«å¿œã˜ã¦å†ç”Ÿæˆã‚’æ¤œè¨ã—ã¦ãã ã•ã„
          3. æº€è¶³ã§ãã‚‹çµæœã®å ´åˆã¯ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„
          
          ---
          *ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          EOF
          
          # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Creating pull request from branch: $CURRENT_BRANCH to main"
          
          # æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯
          EXISTING_PR=$(gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "Pull request already exists: #$EXISTING_PR"
            gh pr view "$EXISTING_PR"
          else
            echo "Creating new pull request..."
            gh pr create \
              --base main \
              --title "ğŸ¬ ç”»åƒâ†’å‹•ç”»ç”Ÿæˆ: ${{ github.event.inputs.base_prompt }}" \
              --body-file pr_body.md \
              && echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆæˆåŠŸï¼" \
              || {
                echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
                echo "Debug information:"
                echo "Current branch: $CURRENT_BRANCH"
                echo "Repository: ${{ github.repository }}"
                echo "Base branch: main" 
                gh pr list --limit 5 2>/dev/null || echo "PR list failed"
                exit 1
              }
          fi
          
          # PR URL ã‚’è¡¨ç¤º
          echo "ä½œæˆã•ã‚ŒãŸãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:"
          gh pr list --head $(git branch --show-current)