name: Gemini Image-to-Video Generation & Analysis

on:
  workflow_dispatch:
    inputs:
      base_prompt:
        description: 'åŸºæœ¬ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆä¾‹ï¼šç¾ã—ã„æ¡œã®èŠ±ã³ã‚‰ã¨çŒ«ãŒéŠã¶é¢¨æ™¯ï¼‰'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.setup.outputs.branch_name }}
      folder_name: ${{ steps.setup.outputs.folder_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup branch and folder
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="video-generation-${TIMESTAMP}"
          FOLDER_NAME="video-${TIMESTAMP}"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b ${BRANCH_NAME}
          mkdir -p ${FOLDER_NAME}/planning ${FOLDER_NAME}/images ${FOLDER_NAME}/videos ${FOLDER_NAME}/analysis
          
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "folder_name=${FOLDER_NAME}" >> $GITHUB_OUTPUT
          
      - name: Commit initial structure
        run: |
          touch ${{ steps.setup.outputs.folder_name }}/README.md
          git add .
          git commit -m "ğŸ¬ Initialize video generation workflow"
          git push origin ${{ steps.setup.outputs.branch_name }}

  planning:
    needs: setup-branch
    runs-on: ubuntu-latest
    outputs:
      image_prompt: ${{ steps.plan.outputs.image_prompt }}
      video_prompt: ${{ steps.plan.outputs.video_prompt }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Setup Gemini
        uses: anthropics/gemini-setup-action@v1
        with:
          api-key: ${{ secrets.GEMINI_API_KEY }}
          
      - name: Plan generation strategy
        id: plan
        run: |
          # Gemini AIã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æœ€é©åŒ–
          gemini code --execute << 'EOF'
          ç”Ÿæˆã—ãŸã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„: ${{ github.event.inputs.base_prompt }}
          
          ä»¥ä¸‹ã®å†…å®¹ã§è¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ï¼š
          1. ç”»åƒç”Ÿæˆç”¨ã®è©³ç´°ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆImagen4 Fastå‘ã‘ï¼‰
          2. å‹•ç”»ç”Ÿæˆç”¨ã®ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆHailuo-02 Proå‘ã‘ï¼‰
          
          ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼š
          - ${{ needs.setup-branch.outputs.folder_name }}/planning/image-prompt.md
          - ${{ needs.setup-branch.outputs.folder_name }}/planning/video-prompt.md
          - ${{ needs.setup-branch.outputs.folder_name }}/planning/planning-strategy.md
          EOF
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‡ºåŠ›ã¨ã—ã¦è¨­å®š
          IMAGE_PROMPT=$(cat ${{ needs.setup-branch.outputs.folder_name }}/planning/image-prompt.md | head -n 1)
          VIDEO_PROMPT=$(cat ${{ needs.setup-branch.outputs.folder_name }}/planning/video-prompt.md | head -n 1)
          
          echo "image_prompt=${IMAGE_PROMPT}" >> $GITHUB_OUTPUT
          echo "video_prompt=${VIDEO_PROMPT}" >> $GITHUB_OUTPUT
          
      - name: Commit planning results
        run: |
          git add .
          git commit -m "ğŸ“ Add generation planning"
          git push

  generate-image:
    needs: [setup-branch, planning]
    runs-on: ubuntu-latest
    outputs:
      image_url: ${{ steps.generate.outputs.image_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Setup Gemini
        uses: anthropics/gemini-setup-action@v1
        with:
          api-key: ${{ secrets.GEMINI_API_KEY }}
          
      - name: Generate image
        id: generate
        run: |
          gemini code --execute << 'EOF'
          MCP t2i-fal-imagen4-fastã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚’ç”Ÿæˆï¼š
          ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${{ needs.planning.outputs.image_prompt }}
          
          ç”Ÿæˆã—ãŸç”»åƒã‚’ä»¥ä¸‹ã«ä¿å­˜ï¼š
          - ${{ needs.setup-branch.outputs.folder_name }}/images/generated-image.jpg
          - URLã‚’${{ needs.setup-branch.outputs.folder_name }}/images/image-url.txtã«ä¿å­˜
          EOF
          
          IMAGE_URL=$(cat ${{ needs.setup-branch.outputs.folder_name }}/images/image-url.txt)
          echo "image_url=${IMAGE_URL}" >> $GITHUB_OUTPUT
          
      - name: Commit image
        run: |
          git add .
          git commit -m "ğŸ–¼ï¸ Add generated image"
          git push

  generate-video:
    needs: [setup-branch, planning, generate-image]
    runs-on: ubuntu-latest
    outputs:
      video_url: ${{ steps.generate.outputs.video_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Setup Gemini
        uses: anthropics/gemini-setup-action@v1
        with:
          api-key: ${{ secrets.GEMINI_API_KEY }}
          
      - name: Generate video
        id: generate
        run: |
          gemini code --execute << 'EOF'
          MCP i2v-fal-hailuo-02-proã‚’ä½¿ç”¨ã—ã¦å‹•ç”»ã‚’ç”Ÿæˆï¼š
          ç”»åƒURL: ${{ needs.generate-image.outputs.image_url }}
          ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${{ needs.planning.outputs.video_prompt }}
          
          ç”Ÿæˆã—ãŸå‹•ç”»ã‚’ä»¥ä¸‹ã«ä¿å­˜ï¼š
          - ${{ needs.setup-branch.outputs.folder_name }}/videos/generated-video.mp4
          - URLã‚’${{ needs.setup-branch.outputs.folder_name }}/videos/video-url.txtã«ä¿å­˜
          EOF
          
          VIDEO_URL=$(cat ${{ needs.setup-branch.outputs.folder_name }}/videos/video-url.txt)
          echo "video_url=${VIDEO_URL}" >> $GITHUB_OUTPUT
          
      - name: Commit video
        run: |
          git add .
          git commit -m "ğŸ¥ Add generated video"
          git push

  analyze-video:
    needs: [setup-branch, generate-video]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Setup Gemini
        uses: anthropics/gemini-setup-action@v1
        with:
          api-key: ${{ secrets.GEMINI_API_KEY }}
          
      - name: Analyze video
        run: |
          gemini code --execute << 'EOF'
          Gemini Visionã‚’ä½¿ç”¨ã—ã¦å‹•ç”»ã‚’åˆ†æï¼š
          å‹•ç”»URL: ${{ needs.generate-video.outputs.video_url }}
          
          ä»¥ä¸‹ã®è¦³ç‚¹ã§åˆ†æï¼š
          1. ç”»è³ªã¨æŠ€è¡“çš„å“è³ª
          2. ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®è‡ªç„¶ã•
          3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã®ä¸€è‡´åº¦
          4. æ”¹å–„ææ¡ˆ
          
          åˆ†æçµæœã‚’ä¿å­˜ï¼š
          - ${{ needs.setup-branch.outputs.folder_name }}/analysis/video-analysis.md
          EOF
          
      - name: Commit analysis
        run: |
          git add .
          git commit -m "ğŸ“Š Add video analysis"
          git push

  create-summary:
    needs: [setup-branch, planning, generate-image, generate-video, analyze-video]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Setup Gemini
        uses: anthropics/gemini-setup-action@v1
        with:
          api-key: ${{ secrets.GEMINI_API_KEY }}
          
      - name: Create summary README
        run: |
          gemini code --execute << 'EOF'
          ${{ needs.setup-branch.outputs.folder_name }}/README.mdã‚’æ›´æ–°ï¼š
          
          # ç”»åƒâ†’å‹•ç”»ç”Ÿæˆçµæœ
          
          ## æ¦‚è¦
          - åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${{ github.event.inputs.base_prompt }}
          - ç”Ÿæˆæ—¥æ™‚: $(date)
          
          ## ç”Ÿæˆçµæœ
          - ç”»åƒ: [generated-image.jpg](images/generated-image.jpg)
          - å‹•ç”»: [generated-video.mp4](videos/generated-video.mp4)
          
          ## è©³ç´°
          - [è¨ˆç”»æˆ¦ç•¥](planning/planning-strategy.md)
          - [ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ](planning/image-prompt.md)
          - [å‹•ç”»ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ](planning/video-prompt.md)
          - [å‹•ç”»åˆ†æ](analysis/video-analysis.md)
          EOF
          
      - name: Commit summary
        run: |
          git add .
          git commit -m "ğŸ“š Add workflow summary"
          git push

  create-pull-request:
    needs: [setup-branch, create-summary]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.setup-branch.outputs.branch_name }}
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          branch: ${{ needs.setup-branch.outputs.branch_name }}
          title: "ğŸ¬ ç”»åƒâ†’å‹•ç”»ç”Ÿæˆ: ${{ github.event.inputs.base_prompt }}"
          body: |
            ## ç”»åƒâ†’å‹•ç”»ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†
            
            ### ç”Ÿæˆå†…å®¹
            **åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: ${{ github.event.inputs.base_prompt }}
            
            ### æˆæœç‰©
            - ğŸ“ **ãƒ•ã‚©ãƒ«ãƒ€**: `${{ needs.setup-branch.outputs.folder_name }}/`
            - ğŸ–¼ï¸ **ç”»åƒ**: ç”Ÿæˆå®Œäº†
            - ğŸ¥ **å‹•ç”»**: ç”Ÿæˆå®Œäº†
            - ğŸ“Š **åˆ†æ**: å®Œäº†
            
            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. ç”Ÿæˆçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„
            2. å¿…è¦ã«å¿œã˜ã¦å†ç”Ÿæˆã‚’æ¤œè¨ã—ã¦ãã ã•ã„
            3. æº€è¶³ã§ãã‚‹çµæœã®å ´åˆã¯ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„
            
            ---
            *ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*